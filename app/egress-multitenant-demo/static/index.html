<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Multi-tenancy Egress Proxy Demo</title>
        <style>
            body {
                font-family: "Arial", sans-serif;
                line-height: 1.6;
                color: #333;
                max-width: 1000px;
                margin: 0 auto;
                padding: 20px;
                background-color: #f4f4f4;
            }
            .container {
                background-color: white;
                border-radius: 8px;
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
                padding: 30px;
                margin-top: 20px;
            }
            h1 {
                color: #2c3e50;
                text-align: center;
                border-bottom: 2px solid #3498db;
                padding-bottom: 10px;
            }
            .info-card {
                background-color: #f8f9fa;
                border-left: 4px solid #3498db;
                padding: 15px;
                margin: 15px 0;
                border-radius: 4px;
            }
            .proxy-info {
                background-color: #e8f5e8;
                border-left: 4px solid #2ecc71;
            }
            .api-info {
                background-color: #fff3cd;
                border-left: 4px solid #ffc107;
            }
            button {
                background-color: #3498db;
                color: white;
                border: none;
                padding: 10px 20px;
                border-radius: 4px;
                cursor: pointer;
                font-size: 16px;
                margin: 10px 0;
            }
            button:hover {
                background-color: #2980b9;
            }
            pre {
                background-color: #f0f0f0;
                padding: 15px;
                border-radius: 4px;
                overflow: auto;
            }
            .status-ok {
                color: #2ecc71;
            }
            .status-error {
                color: #e74c3c;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <h1>üåê Multi-tenancy Egress Proxy Demo</h1>

            <div class="info-card">
                <h2>üéØ Purpose</h2>
                <p>
                    This demo application demonstrates how Kubernetes workloads
                    can be isolated with dedicated egress proxies. All outbound
                    traffic from this application will go through a dedicated
                    proxy server, ensuring network isolation between tenants.
                </p>
            </div>

            <div class="info-card proxy-info">
                <h2>üõ°Ô∏è Egress Proxy Configuration</h2>
                <p>
                    The application is configured to use an egress proxy at
                    <code>PROXY_URL_PLACEHOLDER</code>. All outbound HTTP/HTTPS
                    traffic will be routed through this proxy.
                </p>
                <p><strong>Environment Variables:</strong></p>
                <pre>
HTTP_PROXY=http://172.16.28.8:3128
HTTPS_PROXY=http://172.16.28.8:3128
            </pre
                >
            </div>

            <div class="info-card">
                <h2>üîß Test Your Connection</h2>
                <p>
                    Click the button below to test your external IP address. If
                    the proxy is working correctly, you should see the proxy's
                    IP address, not the node's IP address.
                </p>
                <button id="testButton">Test External IP</button>
                <div id="result"></div>
            </div>

            <div class="info-card api-info">
                <h2>üåê External API Test</h2>
                <p>Test connectivity to external APIs through the proxy:</p>
                <button id="ipInfoButton">Test ipinfo.io</button>
                <button id="httpBinButton">Test httpbin.org</button>
                <div id="apiResult"></div>
            </div>

            <div class="info-card">
                <h2>‚öôÔ∏è System Information</h2>
                <p>
                    <strong>Pod Name:</strong>
                    <span id="podName">Loading...</span>
                </p>
                <p>
                    <strong>Node Name:</strong>
                    <span id="nodeName">Loading...</span>
                </p>
                <p>
                    <strong>Namespace:</strong>
                    <span id="namespace">Loading...</span>
                </p>
                <p>
                    <strong>Host IP:</strong>
                    <span id="hostIP">Loading...</span>
                </p>
                <p>
                    <strong>Pod IP:</strong> <span id="podIP">Loading...</span>
                </p>
                <p>
                    <strong>Current Time:</strong>
                    <span id="currentTime">Loading...</span>
                </p>
            </div>
        </div>

        <script>
            // Update current time
            function updateCurrentTime() {
                const now = new Date();
                document.getElementById("currentTime").textContent =
                    now.toString();
            }
            updateCurrentTime();
            setInterval(updateCurrentTime, 1000);

            // Get pod information
            fetch("/api/system", {
                headers: {
                    Accept: "application/json",
                },
            })
                .then((response) => response.json())
                .then((data) => {
                    document.getElementById("podName").textContent =
                        data.podName || "Unknown";
                    document.getElementById("nodeName").textContent =
                        data.nodeName || "Unknown";
                    document.getElementById("namespace").textContent =
                        data.namespace || "Unknown";
                    document.getElementById("hostIP").textContent =
                        data.hostIP || "Unknown";
                    document.getElementById("podIP").textContent =
                        data.podIP || "Unknown";
                })
                .catch((error) => {
                    console.error("Error fetching system info:", error);
                    document.getElementById("podName").textContent = "Error";
                    document.getElementById("nodeName").textContent = "Error";
                    document.getElementById("namespace").textContent = "Error";
                    document.getElementById("hostIP").textContent = "Error";
                    document.getElementById("podIP").textContent = "Error";
                });

            // Test external IP
            document
                .getElementById("testButton")
                .addEventListener("click", function () {
                    const resultDiv = document.getElementById("result");
                    resultDiv.innerHTML =
                        "<p>Checking your external IP... ‚è≥</p>";

                    fetch("/api/external-ip")
                        .then((response) => {
                            if (!response.ok) {
                                throw new Error(
                                    `HTTP error! status: ${response.status}`,
                                );
                            }
                            return response.json();
                        })
                        .then((data) => {
                            resultDiv.innerHTML = `
                        <p>‚úÖ Success! Your traffic is routed through the egress proxy.</p>
                        <p><strong>External IP:</strong> ${data.ip}</p>
                        <p><em>This should be the proxy's public IP address.</em></p>
                    `;
                        })
                        .catch((error) => {
                            resultDiv.innerHTML = `
                        <p>‚ùå Error: Could not determine external IP</p>
                        <p><em>${error.message}</em></p>
                        <p>Check if the proxy server (172.16.28.8:3128) is reachable and properly configured.</p>
                    `;
                            console.error("Error fetching external IP:", error);
                        });
                });

            // Test external APIs
            document
                .getElementById("ipInfoButton")
                .addEventListener("click", function () {
                    const resultDiv = document.getElementById("apiResult");
                    resultDiv.innerHTML =
                        "<p>Testing connection to ipinfo.io... ‚è≥</p>";

                    fetch("/api/test-ipinfo")
                        .then((response) => {
                            if (!response.ok) {
                                throw new Error(
                                    `HTTP error! status: ${response.status}`,
                                );
                            }
                            return response.json();
                        })
                        .then((data) => {
                            resultDiv.innerHTML = `
                        <p>‚úÖ Successfully connected to ipinfo.io!</p>
                        <p><strong>Your location:</strong> ${data.city || "Unknown"}, ${data.region || "Unknown"}, ${data.country || "Unknown"}</p>
                        <p><strong>IP:</strong> ${data.ip}</p>
                    `;
                        })
                        .catch((error) => {
                            resultDiv.innerHTML = `
                        <p>‚ùå Error connecting to ipinfo.io</p>
                        <p><em>${error.message}</em></p>
                    `;
                            console.error("Error testing ipinfo:", error);
                        });
                });

            document
                .getElementById("httpBinButton")
                .addEventListener("click", function () {
                    const resultDiv = document.getElementById("apiResult");
                    resultDiv.innerHTML =
                        "<p>Testing connection to httpbin.org... ‚è≥</p>";

                    fetch("/api/test-httpbin")
                        .then((response) => {
                            if (!response.ok) {
                                throw new Error(
                                    `HTTP error! status: ${response.status}`,
                                );
                            }
                            return response.json();
                        })
                        .then((data) => {
                            resultDiv.innerHTML = `
                        <p>‚úÖ Successfully connected to httpbin.org!</p>
                        <p><strong>Your IP:</strong> ${data.origin}</p>
                        <p><strong>HTTP Method:</strong> ${data.method}</p>
                    `;
                        })
                        .catch((error) => {
                            resultDiv.innerHTML = `
                        <p>‚ùå Error connecting to httpbin.org</p>
                        <p><em>${error.message}</em></p>
                    `;
                            console.error("Error testing httpbin:", error);
                        });
                });
        </script>
    </body>
</html>
